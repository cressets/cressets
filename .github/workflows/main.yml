name: Deploy Cressets (Final Working)

on:
  push:
    branches:
      - master  # 기본 브랜치가 main이면 main으로 변경

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Node.js 설치
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3. 의존성 설치 (빌드용)
      - name: Install dependencies
        run: npm ci

      # 4. 빌드
      - name: Build
        run: npm run build
        env:
          API_KEY: ${{ secrets.API_KEY }}
          DATABASE_URL: "file:./prod.db"

      # 4.1. 빌드 폴더 확인 (디버깅용)
      - name: Debug build folders
        run: ls -la

      # 5. 빌드 산출물 압축 (Standalone 모드 최적화)
      # .next/standalone 폴더가 실행에 필요한 최소한의 node_modules를 포함함
      - name: Archive build artifacts
        run: |
          cp -r .next/static .next/standalone/.next/static
          cp -r public .next/standalone/public
          cd .next/standalone
          tar -czf ../../artifact.tar.gz .

      # 6. SCP로 압축 파일 전송 (이전 파일 삭제 없이 바로 전송)
      - name: Upload build artifacts
        uses: appleboy/scp-action@v1
        with:
          host: cressets.mooo.com
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: artifact.tar.gz
          target: /var/www/cressets

      # 7. 단 한 번의 SSH 연결로 압축 해제, 구버전 정리, PM2 재시작 처리
      - name: Extract artifacts & Clean & Restart
        uses: appleboy/ssh-action@v1
        env:
          API_KEY: ${{ secrets.API_KEY }}
        with:
          host: cressets.mooo.com
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          envs: API_KEY
          command_timeout: 15m
          script: |
            # 1. 환경 변수 로드
            [ -s "$HOME/.profile" ] && source "$HOME/.profile"
            [ -s "$HOME/.bashrc" ] && source "$HOME/.bashrc"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            cd /var/www/cressets

            # 2. 기존 실행 파일들을 임시 폴더로 이동 (삭제보다 빠름)
            mkdir -p old_build
            mv .next public server.js old_build/ 2>/dev/null || true

            # 3. 새 압축 파일 해제
            tar -xzf artifact.tar.gz
            rm artifact.tar.gz

            # 4. PM2 재시작 (Standalone 서버 실행)
            pm2 describe cressets > /dev/null 2>&1 && API_KEY=$API_KEY pm2 reload cressets --update-env || API_KEY=$API_KEY PORT=3000 pm2 start server.js --name "cressets"
            pm2 save

            # 5. 구버전 파일 백그라운드 삭제 (I/O 부하 분산)
            rm -rf old_build &
