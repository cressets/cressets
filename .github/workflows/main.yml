name: Deploy Cressets (Final Working)

on:
  push:
    branches:
      - master  # 기본 브랜치가 main이면 main으로 변경

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Node.js 설치
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3. 의존성 설치 (빌드용)
      - name: Install dependencies
        run: npm ci

      # 4. 빌드
      - name: Build
        run: npm run build

      # 4.1. 빌드 폴더 확인 (디버깅용)
      - name: Debug build folders
        run: ls -la

      # 5. 서버에서 이전 빌드 삭제 (용량 절약)
      - name: Clean previous build on server
        uses: appleboy/ssh-action@v1
        with:
          host: cressets.mooo.com
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            cd /var/www/cressets
            rm -rf .next public

      # 6. SCP로 빌드 산출물 전송 (명확한 경로 지정)
      - name: Upload build artifacts
        uses: appleboy/scp-action@v1
        with:
          host: cressets.mooo.com
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: |
            .next
            public
          target: /var/www/cressets
          strip_components: 1

      # 7. 서버에서 의존성 설치 + PM2 재시작
      - name: Install deps & restart PM2
        uses: appleboy/ssh-action@v1
        with:
          host: cressets.mooo.com
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            cd /var/www/cressets

            # 프로덕션 의존성만 설치
            npm ci --production

            # PM2 재시작 (앱이 없으면 start, 있으면 reload)
            pm2 describe cressets || pm2 start npm --name "cressets" -- start -- -p 3000
            pm2 reload cressets
            pm2 save
