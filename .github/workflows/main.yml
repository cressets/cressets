name: Deploy Cressets (Lightweight)

on:
  push:
    branches:
      - master  # 실제 기본 브랜치 확인 (main이라면 main으로 수정)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Node.js 설정
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3. 의존성 설치 (빌드용)
      - name: Install dependencies
        run: npm ci

      # 4. Build
      - name: Build
        run: npm run build

      # 5. 서버로 빌드 산출물 전송
      - name: Deploy build artifacts
        uses: appleboy/scp-action@v0.1.7
        with:
          host: cressets.mooo.com
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: |
            .next
            public
            package.json
            package-lock.json
            next.config.js
          target: /var/www/cressets

      # 6. 서버에서 기존 파일 삭제, 의존성 설치 및 PM2 재시작
      - name: Install deps & restart PM2
        uses: appleboy/ssh-action@v1.1.5
        with:
          host: cressets.mooo.com
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            # 배포 전 기존 파일 삭제
            rm -rf /var/www/cressets/*

            # 환경 변수 설정
            export APP_DIR=/var/www/cressets
            export APP_NAME=cressets
            export PORT=3000

            cd $APP_DIR

            # 프로덕션 의존성 설치
            npm ci --production

            # PM2 재시작 (앱이 없으면 start, 있으면 reload)
            pm2 describe $APP_NAME || pm2 start npm --name "$APP_NAME" -- start -- -p $PORT
            pm2 reload $APP_NAME
            pm2 save
