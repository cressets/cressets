name: Deploy Cressets (Final Working)

on:
  push:
    branches:
      - master  # 기본 브랜치가 main이면 main으로 변경

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Node.js 설치
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3. 의존성 설치 (빌드용)
      - name: Install dependencies
        run: npm ci

      # 3.1. Prisma Generate & DB Push (빌드용 임시 DB 생성)
      - name: Initialize Database for Build
        run: |
          npx prisma generate
          npx prisma db push
        env:
          DATABASE_URL: "file:./prod.db"

      # 4. 빌드
      - name: Build
        run: npm run build
        env:
          API_KEY: ${{ secrets.API_KEY }}
          DATABASE_URL: "file:./prod.db"

      # 5. 빌드 산출물 압축 (Standalone 모드 최적화)
      - name: Archive build artifacts
        run: |
          # Standalone용 static 파일 복사
          cp -r .next/static .next/standalone/.next/static
          cp -r public .next/standalone/public
          
          # Prisma 스키마 및 마이그레이션 도구 포함 (서버에서 DB 업데이트용)
          cp -r prisma .next/standalone/prisma
          
          cd .next/standalone
          tar -czf ../../artifact.tar.gz .

      # 6. SCP로 압축 파일 전송
      - name: Upload build artifacts
        uses: appleboy/scp-action@v1
        with:
          host: cressets.mooo.com
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: artifact.tar.gz
          target: /var/www/cressets

      # 7. SSH 연결: 압축 해제, DB 마이그레이션, 재시작
      - name: Extract artifacts & Deploy
        uses: appleboy/ssh-action@v1
        env:
          API_KEY: ${{ secrets.API_KEY }}
        with:
          host: cressets.mooo.com
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          envs: API_KEY
          command_timeout: 15m
          script: |
            # 환경 설정
            [ -s "$HOME/.profile" ] && source "$HOME/.profile"
            [ -s "$HOME/.bashrc" ] && source "$HOME/.bashrc"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            cd /var/www/cressets

            # 백업 및 준비
            mkdir -p old_build
            mv .next public server.js old_build/ 2>/dev/null || true

            # 압축 해제
            tar -xzf artifact.tar.gz
            rm artifact.tar.gz

            # DB 마이그레이션 (서버의 prod.db 업데이트)
            # Standalone에는 npx가 없을 수 있으므로 node_modules/.bin/prisma 사용 시도
            if [ -f "node_modules/.bin/prisma" ]; then
              DATABASE_URL="file:./prod.db" ./node_modules/.bin/prisma db push
            else
              # 없을 경우 글로벌 npx 시도 (서버에 설치되어 있다고 가정)
              DATABASE_URL="file:./prod.db" npx prisma db push
            fi

            # PM2 재시작 (메모리 제한 옵션 추가 고려)
            # --max-memory-restart 800M: 메모리 누수 방지 안전장치
            pm2 describe cressets > /dev/null 2>&1 && API_KEY=$API_KEY pm2 reload cressets --update-env || API_KEY=$API_KEY PORT=3000 pm2 start server.js --name "cressets" --max-memory-restart 800M
            pm2 save

            # 정리
            rm -rf old_build &
