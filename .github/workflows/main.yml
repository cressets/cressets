name: Deploy Cressets (Final Working)

on:
  push:
    branches:
      - master  # 기본 브랜치가 main이면 main으로 변경

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Node.js 설치
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3. 의존성 설치 (빌드용)
      - name: Install dependencies
        run: npm ci

      # 4. 빌드
      - name: Build
        run: npm run build

      # 4.1. 빌드 폴더 확인 (디버깅용)
      - name: Debug build folders
        run: ls -la

      # 5. 빌드 산출물 압축 (Standalone 모드 최적화)
      # .next/standalone 폴더가 실행에 필요한 최소한의 node_modules를 포함함
      - name: Archive build artifacts
        run: |
          cp -r .next/static .next/standalone/.next/static
          cp -r public .next/standalone/public
          cd .next/standalone
          tar -czf ../../artifact.tar.gz .

      # 6. 서버에서 이전 파일 정리 (용량 절약)
      - name: Clean previous build on server
        uses: appleboy/ssh-action@v1
        with:
          host: cressets.mooo.com
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            cd /var/www/cressets
            rm -rf .next public server.js node_modules artifact.tar.gz

      # 7. SCP로 압축 파일 전송
      - name: Upload build artifacts
        uses: appleboy/scp-action@v1
        with:
          host: cressets.mooo.com
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: artifact.tar.gz
          target: /var/www/cressets

      # 8. 서버에서 압축 해제 및 PM2 재시작 (의존성 설치 생략)
      - name: Extract artifacts & restart PM2
        uses: appleboy/ssh-action@v1
        with:
          host: cressets.mooo.com
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            # 환경 변수 로드
            [ -s "$HOME/.profile" ] && source "$HOME/.profile"
            [ -s "$HOME/.bashrc" ] && source "$HOME/.bashrc"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            cd /var/www/cressets

            # 압축 해제 및 파일 삭제
            tar -xzf artifact.tar.gz
            rm artifact.tar.gz

            # PM2 재시작 (Standalone 서버 실행)
            # PORT 환경변수를 지정하여 3000포트로 실행
            pm2 describe cressets > /dev/null 2>&1 && pm2 reload cressets || PORT=3000 pm2 start server.js --name "cressets"
            pm2 save
